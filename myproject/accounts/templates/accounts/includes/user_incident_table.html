{# accounts/includes/user_incident_table.html #}
{% load static %}

<div class="table-responsive">
    <table class="table table-striped table-hover mb-0">
        <thead class="bg-light">
            <tr>
                <th>Ticket #</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Assigned To</th>
                <th>Created On</th>
                <th>Resolved At</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for incident in tickets %}
            <tr>
                <td><a href="{% url 'incident_detail' incident.id %}" class="fw-bold">{{ incident.incident_number }}</a></td>
                <td>
                    <span class="badge 
                        {% if incident.priority == 'high' %}bg-danger
                        {% elif incident.priority == 'medium' %}bg-warning text-dark
                        {% else %}bg-secondary
                        {% endif %}">
                        {{ incident.get_priority_display }}
                    </span>
                </td>
                <td>
                    {# Status Display with dynamic colors #}
                    <span class="badge 
                        {% if incident.status == 'CLOSED' %}bg-success
                        {% elif incident.status == 'REOPENED' %}bg-danger
                        {% elif incident.status == 'AWAITING_FEEDBACK' %}bg-warning text-dark
                        {% else %}bg-info
                        {% endif %}">
                        {{ incident.get_status_display }}
                    </span>
                </td>
                
                <td>
                    {# Display Assigned Agent or Unassigned status #}
                    {% if incident.assigned_to %}
                        {{ incident.assigned_to.get_full_name|default:incident.assigned_to.username }}
                    {% else %}
                        — Unassigned —
                    {% endif %}
                </td>

                <td>
                    {# Display Creation Date and Time (using the original fields) #}
                    {{ incident.created_on|date:"M d, Y" }} <br>
                    <small>{{ incident.created_time|time:"h:i A" }}</small>
                </td>

                <td>
                    {# Display Resolved Date and Time (using the fixed, timezone-safe fields) #}
                    {% if incident.resolved_at %}
                        {{ incident.resolved_date|date:"M d" }}<br>
                        <small class="text-success">{{ incident.resolved_at|date:"h:i A" }}</small>
                    {% else %}
                        —
                    {% endif %}
                </td>

                <td>
                    {% if incident.status == 'AWAITING_FEEDBACK' %}
                        <a href="{% url 'submit_feedback' incident.id %}" class="btn btn-sm btn-danger">
                            <i class="fas fa-comment-dots"></i> Feedback
                        </a>
                    {% else %}
                        <a href="{% url 'incident_detail' incident.id %}" class="btn btn-sm btn-outline-info">
                            View
                        </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>