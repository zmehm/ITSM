{# accounts/includes/ticket_table.html #}

<div class="table-responsive">
    <table class="table table-striped table-hover mb-0">
        <thead class="bg-light">
            <tr>
                <th>Ticket #</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Summary</th>
                <th>Reporter</th>
                <th>Created On</th>
                
                {# Column only shown on support dashboard #}
                {% if is_support_view %}
                    <th>Assigned To</th>
                    <th>Action</th>
                {% else %}
                    <th>Action</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for incident in tickets %}
            <tr>
                <td><a href="{% url 'incident_detail' incident.id %}" class="fw-bold">{{ incident.incident_number }}</a></td>
                
                <td>
                    <span class="badge 
                        {% if incident.priority == 'high' %}bg-danger
                        {% elif incident.priority == 'medium' %}bg-warning text-dark
                        {% else %}bg-secondary
                        {% endif %}">
                        {{ incident.get_priority_display }}
                    </span>
                </td>
                
                <td>
                    <span class="badge 
                        {% if incident.status == 'NEW' %}bg-danger
                        {% elif incident.status == 'REOPENED' %}bg-danger
                        {% elif incident.status == 'IN_PROGRESS' %}bg-info
                        {% elif incident.status == 'AWAITING_FEEDBACK' %}bg-warning text-dark
                        {% elif incident.status == 'CLOSED' %}bg-success
                        {% else %}bg-secondary
                        {% endif %}">
                        {{ incident.get_status_display }}
                    </span>
                </td>

                <td>{{ incident.description|truncatechars:40 }}</td>
                <td>{{ incident.empID.get_full_name|default:incident.empID.username }}</td>
                <td>{{ incident.created_on|date:"M d, Y" }}</td>

                {# Support Columns #}
                {% if is_support_view %}
                    <td>
                        {% if incident.assigned_to %}
                            {{ incident.assigned_to.get_full_name|default:incident.assigned_to.username }}
                        {% else %}
                            — Unassigned —
                        {% endif %}
                    </td>

                    <td>
                        {# ACTION BUTTONS LOGIC #}
                        {% if incident.status in 'NEW,REOPENED' and incident.assigned_to is None %}
                            <a href="{% url 'take_incident' incident.id %}" class="btn btn-sm btn-success">
                                <i class="fas fa-hand-paper me-1"></i> Take
                            </a>
                        {% elif incident.status == 'IN_PROGRESS' %}
                            <a href="{% url 'resolve_incident' incident.id %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-check-circle me-1"></i> Resolve
                            </a>
                        {% elif incident.status == 'AWAITING_FEEDBACK' %}
                            {# Show only a view button for feedback tickets #}
                            <a href="{% url 'incident_detail' incident.id %}" class="btn btn-sm btn-outline-warning">
                                <i class="fas fa-eye me-1"></i> View
                            </a>
                        {% else %}
                            <a href="{% url 'incident_detail' incident.id %}" class="btn btn-sm btn-outline-secondary">
                                View
                            </a>
                        {% endif %}
                    </td>
                {% else %}
                    {# User Dashboard Columns (Not provided here, but kept for logic separation) #}
                    <td>
                        <a href="{% url 'incident_detail' incident.id %}" class="btn btn-sm btn-outline-info">
                            View
                        </a>
                    </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>